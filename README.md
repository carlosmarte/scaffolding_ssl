# scaffolding_ssl

macOS shell scripts for installing and configuring custom CA certificates across multiple language runtimes. All scripts and artifacts live under `~/ssl/`.

## Quick Start

```bash
# 1. Install the scripts
cp *.sh ~/ssl/

# 2. Split, inspect, and install a PEM bundle
~/ssl/install-certs.sh /path/to/bundle.pem

# 3. Source the script for your language
source ~/ssl/ssl-node.sh
source ~/ssl/ssl-python.sh
```

## Directory Layout

After running `install-certs.sh`, `~/ssl/` will contain:

```
~/ssl/
├── install-certs.sh       # Main installer (split, inspect, keychain import)
├── ssl-node.sh            # Node.js env setup
├── ssl-python.sh          # Python / pip env setup
├── ssl-java.sh            # Java truststore builder
├── ssl-go.sh              # Go env setup
├── ssl-rust.sh            # Rust env setup
├── ssl-openssl.sh         # OpenSSL / general TLS env setup
├── ca-bundle.pem          # Rebuilt clean CA bundle (generated)
├── truststore.p12         # Java PKCS12 truststore (generated by ssl-java.sh)
└── certs_out/             # Individual cert files (generated)
    ├── cert-0001.pem
    ├── cert-0002.pem
    └── ...
```

## Scripts

### install-certs.sh

The main entry point. Takes a PEM bundle file, splits it into individual certificates, inspects them, rebuilds a clean bundle, and optionally imports into the macOS System keychain.

```bash
~/ssl/install-certs.sh <bundle.pem>
```

**What it does:**

1. Creates `~/ssl/certs_out/`
2. Splits the PEM bundle into individual certificate files using `csplit`
3. Removes empty fragments and invalid certificates
4. Inspects each certificate (subject, issuer, validity dates, SHA-256 fingerprint)
5. Rebuilds a clean `~/ssl/ca-bundle.pem` from valid certs only
6. Prompts to import certs into the macOS System keychain via `sudo security add-trusted-cert` (interactive, safe to decline)

**Prerequisites:** `openssl`, `csplit` (ships with macOS)

---

### ssl-node.sh

Configures SSL trust for **Node.js**.

```bash
source ~/ssl/ssl-node.sh
```

| Variable | Value |
|---|---|
| `NODE_EXTRA_CA_CERTS` | `~/ssl/ca-bundle.pem` |

Node.js accepts a single PEM file (can be a multi-cert bundle) via `NODE_EXTRA_CA_CERTS`. These certificates are appended to the default root CAs built into Node.

---

### ssl-python.sh

Configures SSL trust for **Python** (`requests`, `urllib3`, `pip`, stdlib `ssl`).

```bash
source ~/ssl/ssl-python.sh
```

| Variable | Value | Used By |
|---|---|---|
| `REQUESTS_CA_BUNDLE` | `~/ssl/ca-bundle.pem` | `requests`, `urllib3` |
| `SSL_CERT_FILE` | `~/ssl/ca-bundle.pem` | Python `ssl` module, `httpx`, `aiohttp` |
| `PIP_CERT` | `~/ssl/ca-bundle.pem` | `pip` |

To make the pip setting permanent without env vars:

```bash
pip config set global.cert "$HOME/ssl/ca-bundle.pem"
```

> **Note:** The env var is `REQUESTS_CA_BUNDLE` (not `REQUEST_CS_BUNDLE`).

---

### ssl-java.sh

Configures SSL trust for **Java** by building a PKCS12 truststore.

```bash
source ~/ssl/ssl-java.sh
```

Unlike the other scripts, this one actively creates a file (`~/ssl/truststore.p12`) by importing each certificate from `~/ssl/certs_out/` via `keytool`.

| Variable | Value |
|---|---|
| `JAVA_TOOL_OPTIONS` | `-Djavax.net.ssl.trustStore=~/ssl/truststore.p12 -Djavax.net.ssl.trustStorePassword=changeit` |

**Prerequisites:** `keytool` (ships with any JDK)

The default truststore password is `changeit`. Java often ignores the OS trust store in some deployments and requires its own JKS/PKCS12 truststore.

---

### ssl-go.sh

Configures SSL trust for **Go** (`crypto/x509`).

```bash
source ~/ssl/ssl-go.sh
```

| Variable | Value |
|---|---|
| `SSL_CERT_FILE` | `~/ssl/ca-bundle.pem` |
| `SSL_CERT_DIR` | `~/ssl/certs_out` |

Go's `crypto/x509` uses system roots by default on macOS. If the CA was imported into the macOS System keychain (via `install-certs.sh`), Go picks it up automatically. These env vars serve as a fallback when keychain import is not used.

For programmatic control, append to an `x509.CertPool` and set it on `tls.Config` / `http.Transport`.

---

### ssl-rust.sh

Configures SSL trust for **Rust** (native-tls / OpenSSL backend).

```bash
source ~/ssl/ssl-rust.sh
```

| Variable | Value |
|---|---|
| `SSL_CERT_FILE` | `~/ssl/ca-bundle.pem` |
| `SSL_CERT_DIR` | `~/ssl/certs_out` |

**TLS backend considerations:**

| Cargo Feature | Env Vars Work? | Recommended Approach |
|---|---|---|
| `reqwest` + `native-tls` | Yes | These env vars apply (OpenSSL under the hood) |
| `reqwest` + `rustls` | No | Use `rustls-native-certs` crate to load OS roots, or load the PEM programmatically into the root store |

---

### ssl-openssl.sh

Configures SSL trust for **OpenSSL** and any TLS stack built on it (LibreSSL, BoringSSL).

```bash
source ~/ssl/ssl-openssl.sh
```

| Variable | Value |
|---|---|
| `SSL_CERT_FILE` | `~/ssl/ca-bundle.pem` |
| `SSL_CERT_DIR` | `~/ssl/certs_out` |

This is the general-purpose fallback. Many tools and libraries that link against OpenSSL respect these variables, including `curl`, `wget`, `git` (when built with OpenSSL), and others.

---

## Making It Permanent

Each script prints the exports to add to `~/.zshrc`. To configure all languages at once, add a block like this:

```bash
# ── Custom CA trust (~/ssl) ──────────────────────────────────────
if [[ -f "$HOME/ssl/ca-bundle.pem" ]]; then
  # Node.js
  export NODE_EXTRA_CA_CERTS="$HOME/ssl/ca-bundle.pem"

  # Python / pip
  export REQUESTS_CA_BUNDLE="$HOME/ssl/ca-bundle.pem"
  export SSL_CERT_FILE="$HOME/ssl/ca-bundle.pem"
  export PIP_CERT="$HOME/ssl/ca-bundle.pem"

  # Java (only if truststore exists)
  if [[ -f "$HOME/ssl/truststore.p12" ]]; then
    export JAVA_TOOL_OPTIONS="-Djavax.net.ssl.trustStore=$HOME/ssl/truststore.p12 -Djavax.net.ssl.trustStorePassword=changeit"
  fi

  # Go / Rust / OpenSSL (shared vars)
  # SSL_CERT_FILE already set above
  export SSL_CERT_DIR="$HOME/ssl/certs_out"
fi
```

## macOS Keychain Import

`install-certs.sh` offers to import certs into the **System keychain** so that all apps using macOS Security framework trust them natively. This covers:

- Safari, Chrome, and other apps using SecureTransport
- Go's `crypto/x509` (reads system roots)
- Rust's `native-tls` on macOS (uses SecureTransport)
- Any tool that delegates to the OS trust store

The import uses:

```bash
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain <cert.pem>
```

This requires admin privileges and is **interactive** (you must confirm with `y`).

To import manually later:

```bash
sudo security add-trusted-cert -d -r trustRoot \
  -k /Library/Keychains/System.keychain \
  ~/ssl/certs_out/cert-0001.pem
```

## Environment Variable Reference

| Variable | Languages / Tools |
|---|---|
| `NODE_EXTRA_CA_CERTS` | Node.js |
| `REQUESTS_CA_BUNDLE` | Python `requests`, `urllib3` |
| `SSL_CERT_FILE` | Python stdlib `ssl`, Go, Rust (native-tls), OpenSSL, curl, wget, git |
| `SSL_CERT_DIR` | Go, Rust (native-tls), OpenSSL |
| `PIP_CERT` | pip |
| `JAVA_TOOL_OPTIONS` | Java (JVM-wide via `-D` flags) |
